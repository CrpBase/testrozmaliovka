<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<title>–†–æ–∑–º–∞–ª—å–æ–≤–∫–∞ –Ñ–¥–∏–Ω–æ—Ä–æ–≥–∞</title>
<style>
    body {
        background: #f7f7f7;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: 20px;
    }
    h2 { margin: 0 0 10px; }

    #palette {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
        justify-content: center;
    }

    .color {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid #333;
        box-sizing: border-box;
    }

    .color.active {
        outline: 3px solid #000;
    }

    #controls {
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    button {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #555;
        background: #ffffff;
        cursor: pointer;
    }

    button:hover {
        filter: brightness(0.95);
    }

    canvas {
        border: 2px solid #444;
        background: #ffffff;
        max-width: 90vw;
        height: auto;
        touch-action: none;
    }
</style>
</head>
<body>

<h2>–†–æ–∑–º–∞–ª—å–æ–≤–∫–∞ —î–¥–∏–Ω–æ—Ä–æ–≥–∞ üåà</h2>

<div id="palette"></div>

<div id="controls">
    <button id="resetBtn">–°–∫–∏–Ω—É—Ç–∏</button>
    <button id="saveBtn">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–ª—é–Ω–æ–∫</button>
</div>

<canvas id="canvas" width="600" height="800"></canvas>

<script>
// –ö–æ–ª—å–æ—Ä–∏ –ø–∞–ª—ñ—Ç—Ä–∏
const COLORS = [
    "#ff8ba7", "#ffd166", "#8ecae6", "#bde0fe",
    "#caffbf", "#e5989b", "#f4a261", "#90be6d",
    "#6d597a", "#ffb5a7", "#fec5bb", "#bde4a8"
];

const paletteEl = document.getElementById("palette");
let currentColor = COLORS[0];

// –°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–ª—ñ—Ç—Ä—É
COLORS.forEach((hex, i) => {
    const div = document.createElement("div");
    div.className = "color" + (i === 0 ? " active" : "");
    div.style.background = hex;
    div.dataset.color = hex;
    div.addEventListener("click", () => {
        currentColor = hex;
        document.querySelectorAll(".color").forEach(c => c.classList.remove("active"));
        div.classList.add("active");
    });
    paletteEl.appendChild(div);
});

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const img = new Image();
img.src = "unicorn.png";
img.onload = () => {
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
};

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è hex –≤ RGBA
function hexToRgba(hex) {
    hex = hex.replace("#", "");
    if (hex.length === 3) {
        hex = hex.split("").map(x => x + x).join("");
    }
    const num = parseInt(hex, 16);
    return [
        (num >> 16) & 255,
        (num >> 8) & 255,
        num & 255,
        255
    ];
}

// –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∫–æ–ª—å–æ—Ä—ñ–≤ –∑ –¥–æ–ø—É—Å–∫–æ–º
function colorsMatch(data, index, color, tolerance) {
    const r = data[index];
    const g = data[index + 1];
    const b = data[index + 2];
    const a = data[index + 3];

    return Math.abs(r - color[0]) <= tolerance &&
           Math.abs(g - color[1]) <= tolerance &&
           Math.abs(b - color[2]) <= tolerance &&
           Math.abs(a - color[3]) <= tolerance;
}

// –§–ª—É–¥-—Ñ—ñ–ª
function floodFill(x, y, fillColor, tolerance = 20) {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    const startPos = (y * canvas.width + x) * 4;
    const startColor = [
        data[startPos],
        data[startPos + 1],
        data[startPos + 2],
        data[startPos + 3]
    ];

    // –Ø–∫—â–æ –∫–ª—ñ–∫–Ω—É–ª–∏ –Ω–∞ –≤–∂–µ –ø–æ—Ñ–∞—Ä–±–æ–≤–∞–Ω–∏–π —É —Ç–æ–π —Å–∞–º–∏–π –∫–æ–ª—ñ—Ä - –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ
    const fCol = fillColor;
    if (colorsMatch(startColor, 0, fCol, 0)) {
        return;
    }

    const stack = [[x, y]];
    while (stack.length > 0) {
        const [cx, cy] = stack.pop();
        if (cx < 0 || cx >= canvas.width || cy < 0 || cy >= canvas.height) continue;

        const idx = (cy * canvas.width + cx) * 4;
        if (colorsMatch(data, idx, startColor, tolerance)) {
            data[idx]     = fCol[0];
            data[idx + 1] = fCol[1];
            data[idx + 2] = fCol[2];
            data[idx + 3] = 255;

            stack.push([cx + 1, cy]);
            stack.push([cx - 1, cy]);
            stack.push([cx, cy + 1]);
            stack.push([cx, cy - 1]);
        }
    }

    ctx.putImageData(imageData, 0, 0);
}

// –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É
function handlePointer(evt) {
    const rect = canvas.getBoundingClientRect();
    const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
    const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
    const x = Math.floor((clientX - rect.left) * (canvas.width / rect.width));
    const y = Math.floor((clientY - rect.top) * (canvas.height / rect.height));

    const fillColor = hexToRgba(currentColor);
    floodFill(x, y, fillColor, 25);
}

canvas.addEventListener("click", handlePointer);
canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    handlePointer(e);
}, { passive: false });

// –ö–Ω–æ–ø–∫–∞ "–°–∫–∏–Ω—É—Ç–∏"
document.getElementById("resetBtn").addEventListener("click", () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
});

// –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–∞–ª—é–Ω–∫–∞
document.getElementById("saveBtn").addEventListener("click", () => {
    const link = document.createElement("a");
    link.download = "unicorn_colored.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
});
</script>

</body>
</html>
